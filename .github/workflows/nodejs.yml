name: Automated Release and Publish

on:
  push:
    # Only run this workflow when code is pushed to the 'release' branch
    branches:
      - release
      - main

jobs:
  ## ðŸ§ª Test Job: Runs npm test on both main and release branches
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install dependencies
        # Assuming npm install is enough to prepare for testing
        run: npm install 

      - name: Run Tests
        # Executes the tests
        run: npm test
  release:
    # Only execute this job if the push event is on the 'release' branch
    if: github.ref == 'refs/heads/release'
    # This job handles version bumping, building, tagging, and publishing
    runs-on: ubuntu-latest
    
    # Define necessary permissions for committing/pushing back and publishing packages
    permissions:
      contents: write # Needed for 'npm version' to commit and push the tag/version
      packages: write # Needed for pushing to ghcr.io

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # IMPORTANT: Fetch all history/tags so 'npm version' can create the new tag
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }} 

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Configure Git for automated commits
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      # -----------------------------------------------
      # 1. VERSION BUMPING AND TAGGING
      # -----------------------------------------------
      - name: Auto-increment Version and Create Tag
        id: versioning
        run: |
          # Increment the patch version (e.g., v1.0.0 -> v1.0.1)
          npm version patch -m "chore(release): bump version to %s"
          
          # 2. Extract the new version tag name, which is the latest tag.
          # '--tags' ensures only tags are considered; '--sort=-version:refname' sorts them so the newest is first.
          NEW_VERSION=$(git tag --sort=-version:refname | head -n 1)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Push the Version Commit and Tag
        run: |
          git push origin release
          git push --tags
          
      # -----------------------------------------------
      # 2. BUILD APPLICATION AND DOCKER IMAGE LOCALLY
      # -----------------------------------------------
      - name: Install dependencies and Build Node app
        run: |
          npm run cleaninstall
          npm run build
        # Expose the version to your build process via environment variable
        env:
          APP_VERSION: ${{ steps.versioning.outputs.new_version }}

      - name: Execute Custom Docker Build Command
        run: |
          npm run docker:build

      # -----------------------------------------------
      # 3. TAG AND PUSH DOCKER IMAGE
      # -----------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GitHub Container Registry (ghcr.io)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Retag and Push Docker Image
        run: |
          # The full repository name is e.g., "my-user/bandaid"
          REPO_FULL=${{ github.repository }}
          
          IMAGE_NAME=${REPO_FULL#*/}
          
          IMAGE_ID=ghcr.io/${{ github.repository }}
          VERSION=${{ steps.versioning.outputs.new_version }}
          
          # 1. Tag the locally built image with the final versions
          echo "Tagging $IMAGE_NAME:local-build to $IMAGE_ID:$VERSION and $IMAGE_ID:latest"
          
          # NOTE: The locally built image *must* have been tagged with the extracted IMAGE_NAME
          # in the previous step, specifically: XXX:local-build
          docker tag ${IMAGE_NAME}:local-build $IMAGE_ID:$VERSION
          docker tag ${IMAGE_NAME}:local-build $IMAGE_ID:latest
          
          # 2. Push the newly tagged images to ghcr.io
          echo "Pushing images to ghcr.io..."
          docker push $IMAGE_ID:$VERSION
          docker push $IMAGE_ID:latest